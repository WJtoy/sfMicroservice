<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kkl.kklplus.b2b.sf.mapper.OrderInfoMapper">

	<select id="getList" resultType="com.kkl.kklplus.b2b.sf.entity.OrderInfo" >
		SELECT
			soi.id,
			waybill_no,
			task_code,
			sub_waybill_nos,
			custom_order_id,
			cargo_name,
			receiver_name,
			receiver_phone,
			receiver_address,
			package_count,
			version,
			status,
			service_type,
			remark,
			install_types AS 'installTypesJson',
			process_flag,
			process_time,
			process_comment,
			quarter,
			create_date as 'createDt',
			sale_channel
		FROM
			sf_order_info soi
		LEFT JOIN sf_order_source sos ON soi.order_source = sos.order_source
		<where>
			<choose>
				<when test="beginCreateDt != null ">
					<choose>
						<when test="endCreateDt != null">
							AND create_date between #{beginCreateDt} and #{endCreateDt}
						</when>
						<otherwise>
							AND create_date >= #{beginCreateDt}
						</otherwise>
					</choose>
				</when>
				<otherwise>
					<if test="endCreateDt != null">
						AND create_date &lt;=  #{endCreateDt}
					</if>
				</otherwise>
			</choose>
			AND status = 1 AND process_flag BETWEEN 0 AND 3
			<if test="processFlags != null">
				AND process_flag in
				<foreach collection="processFlags"  item="processFlag" open="(" close=")" separator=",">
					#{processFlag.value}
				</foreach>
			</if>
			<if test="parentBizOrderId != null and parentBizOrderId != ''">
				AND custom_order_id LIKE CONCAT(#{parentBizOrderId}, '%')
			</if>
			<if test="userName != null and userName != ''">
				AND receiver_name LIKE CONCAT(#{userName}, '%')
			</if>
			<if test="userMobile != null and userMobile != ''">
				AND receiver_phone LIKE CONCAT(#{userMobile}, '%')
			</if>
			<if test="userAddress != null and userAddress != ''">
				AND receiver_address LIKE CONCAT('%', #{userAddress}, '%')
			</if>
		</where>
		ORDER BY id
	</select>

	<update id="updateTransferResult">
		UPDATE
			sf_order_info
		SET
			process_flag = #{processFlag},
			process_time = process_time+1,
			<if test="processFlag == 4">
				kkl_order_id = #{kklOrderId},
				kkl_order_no = #{kklOrderNo},
			</if>
			process_comment = #{processComment},
			update_date = #{updateDt}
	  	WHERE
	  		id = #{id}
	</update>
	<update id="cancelOrderFormB2B">
		UPDATE
			sf_order_info
		SET
			process_flag = #{processFlag},
			update_date = #{updateDt},
			process_comment = #{processComment}
	  	WHERE
	  		id = #{id}
	</update>
	<update id="cancelledOrder">
		UPDATE
			sf_order_info
		SET
			process_flag = #{processFlag},
			process_time = process_time+1,
			update_date = #{updateDt},
			process_comment = #{processComment},
			update_by = #{updater}
	  	WHERE
	  		id = #{id}
	</update>

	<select id="findOrderByTaskCode" resultType="com.kkl.kklplus.b2b.sf.entity.OrderInfo" >
		SELECT
			id,
			task_code,
			kkl_order_id,
			status,
			waybill_no
		FROM
			sf_order_info
		WHERE
			task_code = #{taskCode}
		limit 1
	</select>
	<select id="findOrdersProcessFlagByIds" resultType="com.kkl.kklplus.b2b.sf.entity.OrderInfo">
		SELECT
			id,
			task_code,
			custom_order_id,
			process_flag,
			status
		FROM
			sf_order_info
		<where>
			<if test="ids != null and ids.size > 0">
				<choose>
					<when test="ids.size == 1">
						id = #{ids[0]}
					</when>
					<otherwise>
						id in
						<foreach collection="ids" item="id" open="(" close=")" separator=",">
							#{id}
						</foreach>
					</otherwise>
				</choose>
			</if>
		</where>
		<if test="ids == null or ids.size == 0">
			limit 0
		</if>
	</select>
	<select id="findOrderNoById" resultType="java.lang.String">
		SELECT
			task_code
		FROM
			sf_order_info
		WHERE
			id = #{id}
	</select>
    <select id="getSaleChannel" resultType="java.lang.Integer">
		SELECT
			sale_channel
		FROM
			sf_order_source
		WHERE
			order_source = #{orderSource}
		LIMIT 1
	</select>

    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
		insert into sf_order_info(
			waybill_no,
			task_code,
			sub_waybill_nos,
			order_source,
			custom_order_id,
			cargo_name,
			total_volume,
			total_weight,
			receiver_name,
			receiver_phone,
			receiver_address,
			package_count,
			version,
			status,
			service_type,
			remark,
			install_types,
			extend_Info,
			create_by,
			create_date,
			quarter
		)VALUES (
			#{waybillNo},
			#{taskCode},
			#{subWaybillNos},
			#{orderSource},
			#{customOrderId},
			#{cargoName},
			#{totalVolume},
			#{totalWeight},
			#{receiverName},
			#{receiverPhone},
			#{receiverAddress},
			#{packageCount},
			#{version},
			#{status},
			#{serviceType},
			#{remark},
			#{installTypesJson},
			#{extendInfoJson},
			#{createById},
			#{createDt},
			#{quarter}
		)
	</insert>

	<select id="findOrderById" resultType="com.kkl.kklplus.b2b.sf.entity.OrderInfo" >
		select
		waybill_no,
		task_code
		from sf_order_info
		where id = #{orderId}
		LIMIT 1
	</select>




</mapper>